<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shop | Beaming With Joy</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>

<body>
  <div class="announce">✨ Small-batch items — personalization included on select products ✨</div>

  <div class="nav">
    <div class="navInner">
      <div class="navLeft">
        <a class="navLink" href="index.html">Home</a>
        <a class="navLink" href="categories.html">Categories</a>
        <a class="navLink" href="shop.html">All Products</a>
        <a class="navLink" href="contact.html">Contact</a>
      </div>
      <div class="logoCenter"><img src="assets/logo.png" alt="Beaming With Joy"></div>
      <div class="navRight">
        <a class="navLink" href="cart.html">Cart <span class="cartBadge" data-cart-count>0</span></a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Page title + subtitle -->
    <div class="shopHead">
      <div class="sectionTitle" style="margin-bottom:6px;">Browse the Collection</div>
      <div class="shopSub">Find a Little Joy and Make it Yours :)</div>
    </div>

    <div class="shopLayout">
      <!-- Collapsible toggle button -->
      <button class="filtersToggle" id="filtersToggle" type="button" aria-expanded="false">
        Filters <span class="chev" aria-hidden="true">▾</span>
      </button>

      <!-- Sidebar -->
      <aside class="filtersPanel" id="filtersPanel" aria-label="Filters">
        <div class="filtersPanelInner">
          <div class="filtersPanelTitle">Filters</div>
          <div class="filtersHint">
            Selections won’t apply until you press <strong>Apply Filters</strong>.
          </div>

          <div class="filtersBlock">
            <div class="filtersBlockTitle">Categories</div>

            <label class="fOption"><input type="checkbox" name="cat" value="jewelry"> Jewelry</label>
            <label class="fOption"><input type="checkbox" name="cat" value="signs"> Signs</label>
            <label class="fOption"><input type="checkbox" name="cat" value="wooden"> Wooden</label>
            <label class="fOption"><input type="checkbox" name="cat" value="prints"> 3D Prints</label>
            <label class="fOption"><input type="checkbox" name="cat" value="engraved"> Engraved Items</label>
          </div>

          <div class="filtersActions">
            <!-- Use your existing .btn styles -->
            <button class="btn btn-primary" id="applyFilters" type="button">Apply Filters</button>
            <button class="btn btnGhost" id="clearFilters" type="button">Clear</button>
          </div>
        </div>
      </aside>

      <!-- Main area -->
      <section class="shopMain" aria-label="Products">
        <div class="card filtersTop">
          <!-- Search (pending until Apply) -->
          <input id="q" class="input" placeholder="Search products..." />

          <!-- Tags (pending until Apply) -->
          <div class="tabs">
            <button class="tab active" data-tab="all" type="button">All</button>
            <button class="tab" data-tab="deal" type="button">Deals</button>
            <button class="tab" data-tab="gift" type="button">Gifts</button>
            <button class="tab" data-tab="popular" type="button">Popular</button>
          </div>

          <div class="small muted pendingBadge" title="Filters will apply when you press Apply Filters">
            Pending until Apply
          </div>
        </div>

        <div id="shopGrid" class="grid" style="margin-top:12px;"></div>

        <div class="btnRow" style="justify-content:center; margin-top:18px;">
          <button class="btn" disabled>Prev</button>
          <button class="btn" disabled>Next</button>
        </div>
      </section>
    </div>
  </div>

  <script src="assets/products.js"></script>
  <script src="assets/app.js"></script>

  <script>
    // ---------------------------
    // Collapsible sidebar toggle
    // ---------------------------
    const filtersToggle = document.getElementById("filtersToggle");
    const filtersPanel  = document.getElementById("filtersPanel");

    if (filtersToggle && filtersPanel) {
      filtersToggle.addEventListener("click", () => {
        const isOpen = filtersPanel.classList.toggle("open");
        filtersToggle.setAttribute("aria-expanded", String(isOpen));
        filtersToggle.querySelector(".chev").textContent = isOpen ? "▴" : "▾";
      });
    }

    // ---------------------------
    // Pending vs Applied state
    // Nothing changes until Apply
    // ---------------------------
    let pendingTag = null;
    let appliedTag = null;

    let pendingQuery = "";
    let appliedQuery = "";

    let pendingCats = [];
    let appliedCats = [];

    function getCheckedCats(){
      return Array.from(document.querySelectorAll('input[name="cat"]:checked')).map(x => x.value);
    }

    function refreshUsingApplied(){
      const original = window.PRODUCTS ? [...window.PRODUCTS] : [];

      const q = (appliedQuery || "").trim().toLowerCase();
      const cats = appliedCats || [];

      const filtered = original.filter(p => {
        const matchTag = !appliedTag || (p.tags || []).includes(appliedTag);
        const matchQuery = !q
          || (p.name || "").toLowerCase().includes(q)
          || (p.blurb || "").toLowerCase().includes(q);

        // IMPORTANT: categories must match these values in products.js:
        // jewelry | signs | wooden | prints | engraved
        const matchCats = cats.length === 0 || cats.includes(p.category);

        return matchTag && matchQuery && matchCats;
      });

      // Temporarily swap PRODUCTS so renderProductGrid keeps working
      window.PRODUCTS = filtered;
      renderProductGrid("shopGrid", { tag: null, query: "" });
      window.PRODUCTS = original;
    }

    // Apply = commit pending -> applied
    document.getElementById("applyFilters").addEventListener("click", () => {
      appliedTag = pendingTag;
      appliedQuery = pendingQuery;
      appliedCats = pendingCats;
      refreshUsingApplied();
    });

    // Clear = reset everything
    document.getElementById("clearFilters").addEventListener("click", () => {
      document.querySelectorAll('input[name="cat"]').forEach(x => x.checked = false);

      pendingCats = [];
      appliedCats = [];

      pendingTag = null;
      appliedTag = null;

      pendingQuery = "";
      appliedQuery = "";
      document.getElementById("q").value = "";

      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelector('.tab[data-tab="all"]').classList.add("active");

      refreshUsingApplied();
    });

    // Tabs update PENDING only
    document.querySelectorAll("[data-tab]").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        btn.classList.add("active");

        const t = btn.getAttribute("data-tab");
        pendingTag = (t === "all") ? null : t;
      });
    });

    // Search updates PENDING only
    document.getElementById("q").addEventListener("input", (e) => {
      pendingQuery = e.target.value || "";
    });

    // Category checks update PENDING only
    document.querySelectorAll('input[name="cat"]').forEach(box => {
      box.addEventListener("change", () => {
        pendingCats = getCheckedCats();
      });
    });

    document.addEventListener("DOMContentLoaded", () => {
      pendingCats = getCheckedCats();
      refreshUsingApplied();
    });
  </script>
</body>
</html>
